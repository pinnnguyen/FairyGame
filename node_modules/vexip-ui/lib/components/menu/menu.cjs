"use strict";var n=require("vue");require("../menu-item/index.cjs");require("../menu-group/index.cjs");require("../overflow/index.cjs");require("../../common/config/src/index.cjs");var E=require("@vexip-ui/utils"),q=require("./menu-rest.cjs"),$=require("./props.cjs"),B=require("./symbol.cjs"),w=require("./menu-item.cjs"),y=require("./menu-group.cjs"),T=require("../overflow/overflow.cjs"),p=require("../../common/config/src/props.cjs"),C=require("../../common/config/src/namespace.cjs");const H=Object.freeze(["top","right","bottom","left","none"]);var U=n.defineComponent({name:"Menu",components:{MenuRest:q,MenuItem:w,MenuGroup:y,Overflow:T},props:$.menuProps,emits:["update:active"],setup(z,{slots:m,emit:M,expose:j}){const r=p.useProps("menu",z,{active:{default:null,static:!0},accordion:!1,markerType:{default:"right",validator:e=>H.includes(e)},reduced:!1,horizontal:!1,transfer:!1,trigger:"hover",groupType:{default:"collapse",validator:e=>["collapse","dropdown"].includes(e)},tooltipReverse:null,options:{default:()=>[],static:!0},router:null,manualRoute:!1}),u=C.useNameHelper("menu"),i=new Set,l=n.ref(r.active),s=n.ref(!1),f=n.ref(),k=n.ref(),h=n.computed(()=>{var e;return r.horizontal&&(r.markerType==="left"||r.markerType==="right")?"bottom":!r.horizontal&&(r.markerType==="top"||r.markerType==="bottom")?"right":(e=r.markerType)!=null?e:r.horizontal?"bottom":"right"}),I=n.computed(()=>[u.b(),u.bs("vars"),u.bm(`marker-${h.value}`),{[u.bm("inherit")]:r.inherit,[u.bm("reduced")]:s.value,[u.bm("dropdown")]:r.groupType==="dropdown",[u.bm("horizontal")]:r.horizontal}]),v=n.computed(()=>{var t,o;if((t=r.options)!=null&&t.length)return r.options;const e=(o=r.router)==null?void 0:o.options.routes;return e!=null&&e.length?A(e):[]}),N=n.computed(()=>{var e;return(e=r.router)==null?void 0:e.currentRoute.value});n.provide(B.MENU_STATE,n.reactive({currentActive:l,isReduced:s,horizontal:n.toRef(r,"horizontal"),accordion:n.toRef(r,"accordion"),groupType:n.toRef(r,"groupType"),tooltipReverse:n.toRef(r,"tooltipReverse"),transfer:n.toRef(r,"transfer"),trigger:n.toRef(r,"trigger"),markerType:h,handleSelect:F,handleExpand:V,increaseItem:S,decreaseItem:G,beforeExpand:()=>{if(r.accordion)for(const e of i)e.groupExpanded=!1}})),n.watch(()=>r.active,e=>{e!==l.value&&(l.value=e)}),n.watch(()=>r.reduced,e=>{r.horizontal||(e?g():L())}),n.watch(N,e=>{var t;!r.manualRoute&&e&&(l.value=((t=e.meta)==null?void 0:t.label)||e.path)}),n.onMounted(()=>{n.nextTick(()=>{!r.horizontal&&r.reduced&&g()})}),j({expandItemByLabel:P});function A(e){const t={label:"",children:[]},o=Array.from(e).map(a=>({parent:t,route:a}));for(;o.length;){const{parent:a,route:c}=o.shift(),d=c.meta||{};if(d.menu===!1)continue;const R={...d,route:c,label:d.label||c.path,name:d.name||c.name};a.children||(a.children=[]),a.children.push(R),c.children&&o.push(...c.children.map(O=>({parent:R,route:O})))}return t.children}function S(e){i.add(e)}function G(e){i.delete(e)}function F(e,t,o){l.value!==e&&(l.value=e,p.emitEvent(r.onSelect,e,t),M("update:active",e),!r.manualRoute&&r.router&&o&&r.router.push(o))}function V(e,t,o){t?p.emitEvent(r.onExpand,e,o):p.emitEvent(r.onReduce,e,o)}function g(){if(r.horizontal)return;let e=null;for(const t of i)t.cachedExpanded=t.showGroup,!e&&t.showGroup&&(e=t),t.toggleGroupExpanded(!1);s.value=!0}function L(){if(!r.horizontal&&(s.value=!1,f.value)){const e=f.value,t=()=>{requestAnimationFrame(()=>{e.removeEventListener("transitionend",t);const o=Array.from(i).find(a=>a.label===l.value);requestAnimationFrame(()=>{requestAnimationFrame(()=>{for(const a of i)a.groupExpanded=a.cachedExpanded;if(o){let a=o.parentState;for(;a;)a.groupExpanded=!0,a=a.parentState}})})})};e.addEventListener("transitionend",t)}}function P(e){for(const t of i)t.label===e&&t.toggleGroupExpanded(!0,!0)}function b(e){return n.createVNode(w,{label:e.label,icon:e.icon,"icon-props":e.iconProps,disabled:e.disabled,children:e.children,route:e.route},{default:()=>[e.name?E.callIfFunc(e.name):e.label]})}function x(){return v.value.map(e=>e.group?n.createVNode(y,{label:e.name?E.callIfFunc(e.name):e.label},{default:()=>{var t;return[(t=e.children)!=null&&t.length?e.children.map(b):null]}}):b(e))}return()=>n.createVNode("ul",{ref:f,class:I.value,role:"menu",tabindex:-1},[m.default?m.default():r.horizontal?n.createVNode(T,{inherit:!0},{default:x,counter:({count:e})=>n.createVNode(q,{ref:k,menus:v.value.slice(-e)},null)}):x()])}});module.exports=U;
