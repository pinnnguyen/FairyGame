"use strict";var e=require("vue");require("../anchor-link/index.cjs");require("../../common/config/src/index.cjs");var g=require("@vexip-ui/utils"),V=require("./props.cjs"),R=require("./helper.cjs"),z=require("./symbol.cjs"),M=require("../../_virtual/plugin-vue_export-helper.cjs"),I=require("./anchor-link.cjs"),D=require("../../common/config/src/namespace.cjs"),N=require("../../common/config/src/props.cjs");const P=e.defineComponent({name:"Anchor",components:{AnchorLink:I},props:V.anchorProps,emits:["update:active"],setup(o,{emit:q}){const w=D.useNameHelper("anchor"),a=N.useProps("anchor",o,{active:{default:"",static:!0},viewer:{default:null,static:!0},offset:8,marker:!1,scrollDuration:500,markerTransition:()=>w.ns("fade"),options:{default:()=>[],static:!0},bindHash:!1,forceActive:!1}),u=e.ref(a.active),v=e.ref(!1),C=e.ref(0),f=new Set,E=e.ref();let b,d=!1,n=null,p=null;g.isClient&&!u.value&&a.bindHash&&(u.value=decodeURIComponent(location.hash)),e.provide(z.ANCHOR_STATE,e.reactive({currentActive:u,increaseLink:$,decreaseLink:j,handleActive:H})),e.watch(()=>a.active,t=>{u.value=t}),e.watch(u,t=>{N.emitEvent(a.onChange,t),q("update:active",t)}),e.watch(()=>a.viewer,A),e.onMounted(()=>{A(),y()}),e.onBeforeUnmount(()=>{B(),clearTimeout(b)});function $(t){f.add(t),t.active=u.value===t.to}function j(t){f.delete(t)}const S=e.getCurrentInstance();function A(){B(),e.nextTick(()=>{var s,m,l,c;const t=a.viewer;let r=null,i="scroll";if(typeof t=="string"?t.startsWith("ref:")?(i=t.substring(4),i=i||"scroll"):["window","document","body"].includes(t)?r=document.body:t==="root"?r=S.root:r=document.querySelector(t):typeof t=="function"?r=t():g.isElement(t)&&(r=t),g.isElement(r)?d=!0:d=!1,d)n=r,n.addEventListener("scroll",T);else{for(r=r,r=e.isVNode(r==null?void 0:r.vnode)?r:S.parent;r;){const h=(s=r.type)==null?void 0:s.name;if(h==="Scroll"||h==="NativeScroll"){p=r.proxy;break}const k=(m=r.refs)==null?void 0:m[i];if(k){g.isElement(k)?(d=!0,n=k):p=k;break}r=r.parent}p?(p.addScrollListener(T),n=p.$el):n||(d=!0,n=(c=(l=S.parent)==null?void 0:l.proxy)==null?void 0:c.$el),d&&n&&n.addEventListener("scroll",T)}})}function L(t){if(!f.size||!n)return;const r=n.offsetTop,i=[];let s=t+a.offset;d&&(s+=r),f.forEach(l=>{const c=l.to;if(!c.startsWith("#"))return;const h=document.querySelector(c);h&&i.push({link:c,offset:h.offsetTop})}),i.sort((l,c)=>l.offset-c.offset),i.push({link:"",offset:1/0});let m="";for(let l=0,c=i.length-1;l<c;++l){const h=i[l],k=i[l+1];if(h.offset<=s&&k.offset>s){m=h.link;break}}u.value=m}function T(t){if(v.value)return;const r=d?t.target.scrollTop:t.clientY;L(r),y()}function B(){p&&(p.removeScrollListener(T),p=null),n&&n.removeEventListener("scroll",T)}function H(t){if(!a.forceActive&&t===u.value||!t.startsWith("#")||t.length<2)return;const r=document.querySelector(t);if(!r)return;clearTimeout(b),v.value=!0;const i=r.offsetTop,s=Math.max(a.scrollDuration,0);if(d&&n){const m=n.scrollTop,l=Math.min(i-n.offsetTop-a.offset,n.scrollHeight-n.offsetHeight);R.animateScrollTo(n,m,l,s,()=>{b=setTimeout(()=>{v.value=!1},10)}),L(l),y()}else if(p){const[m,l]=p.getYScrollLimit(),c=Math.max(Math.min(i-a.offset,l),m);p.scrollTo(0,c,s),b=setTimeout(()=>{v.value=!1},s+10),L(c),y()}else v.value=!1;g.isClient&&a.bindHash&&location&&(location.hash=encodeURIComponent(u.value.replace(/^#/,"")))}function y(){var r,i;const t=Array.from(f).find(s=>s.to&&s.to===u.value);if(t!=null&&t.el){const s=t.el.getBoundingClientRect(),m=(i=(r=E.value)==null?void 0:r.getBoundingClientRect().top)!=null?i:0;C.value=s.top-m+s.height/2+.5}}return{props:a,nh:w,currentActive:u,markerTop:C,wrapper:E}}});function U(o,q,w,a,u,v){const C=e.resolveComponent("AnchorLink");return e.openBlock(),e.createElementBlock("div",{ref:"wrapper",class:e.normalizeClass({[o.nh.b()]:!0,[o.nh.bs("vars")]:!0,[o.nh.bm("inherit")]:o.props.inherit,[o.nh.bm("no-marker")]:!o.props.marker})},[e.createElementVNode("ul",{class:e.normalizeClass(o.nh.be("list"))},[e.renderSlot(o.$slots,"default",{},()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.props.options,f=>(e.openBlock(),e.createBlock(C,{key:f.to,to:f.to,title:f.title,children:f.children},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f.label),1)]),_:2},1032,["to","title","children"]))),128))])],2),e.createVNode(e.Transition,{appear:"",name:o.props.markerTransition},{default:e.withCtx(()=>[o.props.marker&&o.currentActive?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(o.nh.be("marker")),style:e.normalizeStyle({top:`${o.markerTop}px`})},[e.renderSlot(o.$slots,"marker",{},()=>[e.createElementVNode("div",{class:e.normalizeClass(o.nh.be("pointer"))},null,2)])],6)):e.createCommentVNode("",!0)]),_:3},8,["name"])],2)}var W=M(P,[["render",U]]);module.exports=W;
