"use strict";var t=require("vue"),et=require("./table-head.cjs"),tt=require("./table-body.cjs");require("../scroll/index.cjs");require("../scrollbar/index.cjs");require("../../common/config/src/index.cjs");var p=require("@vexip-ui/utils"),lt=require("@vexip-ui/hooks"),ot=require("./props.cjs"),rt=require("./store.cjs"),A=require("./symbol.cjs"),nt=require("../../_virtual/plugin-vue_export-helper.cjs"),at=require("../scroll/scroll.cjs"),it=require("../scrollbar/scrollbar.cjs"),a=require("../../common/config/src/props.cjs"),st=require("../../common/config/src/namespace.cjs"),ct=require("../../common/config/src/locale/index.cjs");const dt=t.defineComponent({name:"Table",components:{Scroll:at,Scrollbar:it,TableHead:et,TableBody:tt},props:ot.tableProps,emits:[],setup(o){var U;const l=a.useProps("table",o,{columns:{default:()=>[],static:!0},data:{default:()=>[],static:!0},dataKey:A.DEFAULT_KEY_FIELD,width:null,height:null,rowClass:null,rowStyle:null,rowAttrs:null,stripe:!1,border:!1,highlight:!1,useYBar:!1,barFade:1500,scrollDeltaY:36,rowDraggable:!1,rowHeight:null,rowMinHeight:{default:36,validator:e=>e>0},virtual:!1,bufferCount:{default:5,validator:e=>e>=0},scrollClass:()=>({}),expandRenderer:{default:null,isFunc:!0},currentPage:{default:1,validator:e=>e>0,static:!0},pageSize:0,transparent:!1,emptyText:null,tooltipTheme:{default:"dark",validator:e=>["light","dark"].includes(e)},tooltipWidth:500,singleSorter:!1,singleFilter:!1,cellClass:null,cellStyle:null,cellAttrs:null,headClass:null,headStyle:null,headAttrs:null}),h=st.useNameHelper("table"),f=t.ref(l.height),D=t.ref(0),E=t.ref(0),w=t.ref(0),y=t.ref(!1),g=t.ref(new Set),k=t.ref(null),S=t.ref(!1),R=t.ref(),L=t.ref(),T=t.ref(),M=t.ref(),Y=t.ref(),$=ct.useLocale("table"),B=rt.useStore({columns:l.columns,data:l.data,rowClass:l.rowClass,rowStyle:l.rowStyle,rowAttrs:l.rowAttrs,cellClass:l.cellClass,cellStyle:l.cellStyle,cellAttrs:l.cellAttrs,headClass:l.headClass,headStyle:l.headStyle,headAttrs:l.headAttrs,dataKey:l.dataKey,highlight:l.highlight,currentPage:l.currentPage,pageSize:l.pageSize,rowHeight:l.rowHeight,rowMinHeight:l.rowMinHeight,virtual:l.virtual,rowDraggable:l.rowDraggable,emptyText:(U=l.emptyText)!=null?U:$.value.empty,tooltipTheme:l.tooltipTheme,tooltipWidth:l.tooltipWidth,singleSorter:l.singleSorter,singleFilter:l.singleFilter,expandRenderer:l.expandRenderer});t.provide(A.TABLE_STORE,B),t.provide(A.TABLE_ACTION,{increaseColumn:Ee,decreaseColumn:Re,emitRowEnter:ke,emitRowLeave:He,emitRowClick:De,emitRowDblclick:Te,emitRowContextmenu:Be,emitRowCheck:Fe,emitAllRowCheck:Ne,emitRowExpand:ze,emitRowFilter:Ve,emitRowSort:je,handleRowDragStart:xe,handleRowDragOver:qe,handleRowDrop:Ae,handleRowDragEnd:Le,emitCellEnter:Me,emitCellLeave:Ye,emitCellClick:$e,emitCellDblclick:Pe,emitCellContextmenu:We,emitHeadEnter:Oe,emitHeadLeave:Ie,emitHeadClick:Ke,emitHeadDblclick:Xe,emitHeadContextmenu:Ue});const{state:d,getters:F,mutations:G}=B,J=t.computed(()=>({[h.b()]:!0,[h.bs("vars")]:!0,[h.bm("inherit")]:l.inherit,[h.bm("stripe")]:l.stripe,[h.bm("border")]:l.border,[h.bm("highlight")]:l.highlight,[h.bm("use-y-bar")]:l.useYBar,[h.bm("transparent")]:l.transparent,[h.bm("virtual")]:l.virtual})),Q=t.computed(()=>{var r;const e=(r=k.value)!=null?r:l.width;return e!==null?typeof e=="string"&&parseFloat(e).toString()!==e?{width:e}:{width:`${e}px`,minWidth:`${e}px`}:{}}),Z=t.computed(()=>!!(l.width&&(d.leftFixedColumns.length||d.rightFixedColumns.length))),C=t.computed(()=>{const{totalHeight:e}=d;return Number.isNaN(e)?f.value:f.value?Math.min(f.value,e):f.value}),_=t.computed(()=>{const{totalHeight:e}=d;return C.value&&e&&Math.max(Math.min(C.value/e*100,99),5)||35}),ee=t.computed(()=>[...g.value].concat(l.columns)),te=t.computed(()=>{var e;return(e=l.emptyText)!=null?e:$.value.empty}),{setColumns:le,setData:oe,setPageSize:P,setRowClass:re,setHighlight:ne,setCurrentPage:ae,setTableWidth:N,setBodyScroll:z,setRenderRows:V,setGlobalRowHeight:ie,setRowDraggable:se,setEmptyText:ce,setTooltipTheme:de,setTooltipWidth:ue,setSingleSorter:he,setSingleFilter:me,setDragging:W,clearSort:pe,clearFilter:fe,refreshRowIndex:ge,clearCheckAll:ve}=G;t.watch(ee,e=>{le(e)},{immediate:!0,deep:!0}),t.watch(()=>l.data,e=>{P(l.pageSize||e.length),oe(e),q()},{deep:!0}),t.watch(()=>l.width,K),t.watch(()=>l.height,()=>{t.nextTick(j)}),t.watch(()=>l.rowClass,re),t.watch(()=>l.highlight,ne),t.watch(()=>l.currentPage,ae),t.watch(()=>l.pageSize,P),t.watch(()=>l.rowHeight,ie),t.watch(()=>l.rowDraggable,se),t.watch(te,ce),t.watch(()=>l.tooltipTheme,de),t.watch(()=>l.tooltipWidth,ue),t.watch(()=>l.singleSorter,he),t.watch(()=>l.singleFilter,me);function O(){var e;(e=Y.value)==null||e.handleScroll(E.value)}const I=p.debounce(x);t.onMounted(()=>{t.watch(C,q),x(),window.addEventListener("resize",I)}),t.onBeforeUnmount(()=>{window.removeEventListener("resize",I)});function K(){const e=l.width;if(p.isDefined(e))if(typeof e=="string"&&parseFloat(e).toString()!==e)k.value=e,t.nextTick(()=>{R.value&&N(R.value.offsetWidth)});else{const r=p.toNumber(e);k.value=`${r}px`,N(r)}else t.nextTick(()=>{R.value&&N(R.value.offsetWidth)})}function j(){var r;const e=l.height;if(p.isDefined(e)){const n=(r=L.value)==null?void 0:r.$el;n?(w.value=n.offsetHeight,f.value=e-w.value):f.value=e-(l.rowHeight||l.rowMinHeight)}else f.value=void 0}function be({clientY:e,percentY:r}){E.value=r,z(e),O(),Ce(e,r)}function we({percentX:e}){D.value=e}function ye(e){S.value=e}function Se(e){var c;const{totalHeight:r}=d,n=e*(r-((c=C.value)!=null?c:0))/100;E.value=e,z(n),p.nextFrameOnce(H),a.emitEvent(l.onBodyScroll,{client:n,percent:e})}function Ce(e,r){p.nextFrameOnce(H),a.emitEvent(l.onBodyScroll,{client:e,percent:r})}function Ee(e){g.value.add(e)}function Re(e){g.value.delete(e)}function ke(e){a.emitEvent(l.onRowEnter,e)}function He(e){a.emitEvent(l.onRowLeave,e)}function De(e){a.emitEvent(l.onRowClick,e)}function Te(e){a.emitEvent(l.onRowDblclick,e)}function Be(e){a.emitEvent(l.onRowContextmenu,e)}function Fe(e){a.emitEvent(l.onRowCheck,e)}function Ne(e,r){a.emitEvent(l.onRowCheckAll,e,r)}function ze(e){a.emitEvent(l.onRowExpand,e)}function Ve(){const{columns:e,filters:r}=d,n=p.transformListToMap(e,"key"),c=Object.keys(r).filter(i=>r[i].active).map(i=>{const s=n[i];return{name:s.name,key:s.key,metaData:s.metaData,active:r[i].active}});a.emitEvent(l.onRowFilter,c,F.filteredData.map(i=>i.data))}function je(){const{columns:e,sorters:r}=d,n=p.transformListToMap(e,"key"),c=Object.keys(r).filter(i=>r[i].type).map(i=>{const s=n[i];return{name:s.name,key:s.key,metaData:s.metaData,type:r[i].type}});a.emitEvent(l.onRowSort,c,F.sortedData.map(i=>i.data))}let v;function xe(e,r){v={draggingRow:e.row,tableRect:R.value.getBoundingClientRect()},W(!0),a.emitEvent(l.onRowDragStart,e.row.data,r)}function qe(e,r){if(!v||!e.el)return;const n=e.el.getBoundingClientRect(),c=v.tableRect,i=.5,s=r.clientY-n.top,m=n.height;let u="none",b=-9999;s<m*i?(u="before",b=n.top-c.top):(u="after",b=n.bottom-c.top),M.value.style.top=`${b-2}px`,v.dropType=u,y.value=!0,a.emitEvent(l.onRowDragOver,e.row.data,r)}function Ae(e,r){if(!v)return;const{draggingRow:n,dropType:c}=v,i=e.row;if(n.key===i.key)return;const s=d.rowData;let m=s.findIndex(u=>u.key===i.key);if(~m){const u=s.findIndex(b=>b.key===n.key);p.removeArrayItem(s,b=>b.key===n.key),u>m&&c==="after"?m+=1:u<m&&c==="before"&&(m-=1),s.splice(m,0,n),ge(),a.emitEvent(l.onRowDrop,e.row.data,c,r)}}function Le(e){if(!v)return;const{draggingRow:r}=v;v=null,y.value=!1,W(!1),a.emitEvent(l.onRowDragEnd,r.data,d.rowData.map(n=>n.data),e)}function Me(e){a.emitEvent(l.onCellEnter,e)}function Ye(e){a.emitEvent(l.onCellLeave,e)}function $e(e){a.emitEvent(l.onCellClick,e)}function Pe(e){a.emitEvent(l.onCellDblclick,e)}function We(e){a.emitEvent(l.onCellContextmenu,e)}function Oe(e){a.emitEvent(l.onHeadEnter,e)}function Ie(e){a.emitEvent(l.onHeadLeave,e)}function Ke(e){a.emitEvent(l.onHeadClick,e)}function Xe(e){a.emitEvent(l.onHeadDblclick,e)}function Ue(e){a.emitEvent(l.onHeadContextmenu,e)}function H(){const{totalHeight:e,bodyScroll:r,heightBITree:n}=d,{processedData:c}=F,i=c.length;if(!l.virtual){V(0,i);return}const s=Math.min(f.value||0,C.value||0);s||V(0,0);let m=r,u=r+s;u>e&&(u=e,m=u-s);const b=n.boundIndex(m),Qe=n.boundIndex(u),Ze=Math.max(b-l.bufferCount,0),_e=Math.min(Qe+l.bufferCount+1,i);V(Ze,_e)}function x(){setTimeout(()=>{K(),j(),q(),p.nextFrameOnce(H)},0)}function Ge(){T.value&&z(-T.value.currentScroll.y)}const{timer:X}=lt.useSetTimeout();function q(){clearTimeout(X.scroll),X.scroll=setTimeout(()=>{var n;const{totalHeight:e,bodyScroll:r}=d;E.value=Math.max(Math.min(r/(e-((n=C.value)!=null?n:0)||1)*100,100),0),O(),t.nextTick(j),p.nextFrameOnce(H)},10)}function Je(){const e=d.rowData,r=[];for(let n=0,c=e.length;n<c;++n){const i=e[n];i.checked&&r.push(i.data)}return r}return{props:l,nh:h,bodyHeight:f,xScrollPercent:D,yScrollPercent:E,headHeight:w,indicatorShow:y,leftFixedColumns:t.toRef(d,"leftFixedColumns"),rightFixedColumns:t.toRef(d,"rightFixedColumns"),bodyScroll:t.toRef(d,"bodyScroll"),className:J,style:Q,useXScroll:Z,barLength:_,bodyScrollHeight:C,totalHeight:t.toRef(d,"totalHeight"),store:B,wrapper:R,thead:L,mainScroll:T,indicator:M,scrollbar:Y,handleBodyScroll:be,handleXScroll:we,handleYScrollEnableChange:ye,handleYBarScroll:Se,syncVerticalScroll:Ge,clearSort:pe,clearFilter:fe,clearSelected:ve,refresh:x,getSelected:Je}}}),ut=["aria-rowcount"],ht={role:"none"};function mt(o,l,h,f,D,E){const w=t.resolveComponent("TableHead"),y=t.resolveComponent("TableBody"),g=t.resolveComponent("Scroll"),k=t.resolveComponent("Scrollbar");return t.openBlock(),t.createElementBlock("div",{ref:"wrapper",class:t.normalizeClass(o.className),role:"table",style:t.normalizeStyle(o.style),"aria-rowcount":o.props.data.length},[t.withDirectives(t.createElementVNode("div",ht,[t.renderSlot(o.$slots,"default")],512),[[t.vShow,!1]]),o.useXScroll?(t.openBlock(),t.createBlock(g,{key:0,inherit:"","use-x-bar":"",mode:"horizontal",class:t.normalizeClass([o.nh.be("wrapper"),o.props.scrollClass.horizontal]),"bar-class":o.nh.bem("bar","horizontal"),width:o.props.width,"bar-fade":o.props.barFade,"delta-x":50,onScroll:o.handleXScroll},{default:t.withCtx(()=>[t.createVNode(w,{ref:"thead"},null,512),t.createVNode(g,{inherit:"",class:t.normalizeClass([o.nh.be("body-wrapper"),o.props.scrollClass.major]),height:o.bodyScrollHeight,"scroll-y":o.bodyScroll,onScroll:o.handleBodyScroll,onYEnabledChange:o.handleYScrollEnableChange,onReady:o.syncVerticalScroll},{default:t.withCtx(()=>[t.createVNode(y,null,{empty:t.withCtx(({isFixed:S})=>[t.renderSlot(o.$slots,"empty",{isFixed:S})]),_:3})]),_:3},8,["class","height","scroll-y","onScroll","onYEnabledChange","onReady"])]),_:3},8,["class","bar-class","width","bar-fade","onScroll"])):(t.openBlock(),t.createElementBlock(t.Fragment,{key:1},[t.createVNode(w,{ref:"thead"},null,512),t.createVNode(g,{ref:"mainScroll",inherit:"",class:t.normalizeClass([o.nh.be("body-wrapper"),o.props.scrollClass.major]),height:o.bodyScrollHeight,"scroll-y":o.bodyScroll,"delta-y":o.props.scrollDeltaY,onScroll:o.handleBodyScroll,onYEnabledChange:o.handleYScrollEnableChange,onReady:o.syncVerticalScroll},{default:t.withCtx(()=>[t.createVNode(y,null,{empty:t.withCtx(({isFixed:S})=>[t.renderSlot(o.$slots,"empty",{isFixed:S})]),_:3})]),_:3},8,["class","height","scroll-y","delta-y","onScroll","onYEnabledChange","onReady"])],64)),o.leftFixedColumns.length?(t.openBlock(),t.createElementBlock("div",{key:2,class:t.normalizeClass({[o.nh.bem("fixed","left")]:!0,[o.nh.bem("fixed","active")]:o.xScrollPercent})},[t.createVNode(w,{fixed:"left"}),t.createVNode(g,{ref:"mainScroll",inherit:"",class:t.normalizeClass([o.nh.be("body-wrapper"),o.props.scrollClass.left]),height:o.bodyScrollHeight,"scroll-y":o.bodyScroll,"delta-y":o.props.scrollDeltaY,onScroll:o.handleBodyScroll},{default:t.withCtx(()=>[t.createVNode(y,{fixed:"left"},{empty:t.withCtx(({isFixed:S})=>[t.renderSlot(o.$slots,"empty",{isFixed:S})]),_:3})]),_:3},8,["class","height","scroll-y","delta-y","onScroll"])],2)):t.createCommentVNode("",!0),o.rightFixedColumns.length?(t.openBlock(),t.createElementBlock("div",{key:3,class:t.normalizeClass({[o.nh.bem("fixed","right")]:!0,[o.nh.bem("fixed","active")]:o.xScrollPercent!==100})},[t.createVNode(w,{fixed:"right"}),t.createVNode(g,{inherit:"",class:t.normalizeClass([o.nh.be("body-wrapper"),o.props.scrollClass.right]),height:o.bodyScrollHeight,"scroll-y":o.bodyScroll,"delta-y":o.props.scrollDeltaY,onScroll:o.handleBodyScroll},{default:t.withCtx(()=>[t.createVNode(y,{fixed:"right"},{default:t.withCtx(()=>[t.renderSlot(o.$slots,"default")]),_:3})]),_:3},8,["class","height","scroll-y","delta-y","onScroll"])],2)):t.createCommentVNode("",!0),o.props.useYBar&&o.bodyScrollHeight?(t.openBlock(),t.createBlock(k,{key:4,ref:"scrollbar",inherit:"",placement:"right",class:t.normalizeClass(o.nh.bem("bar","vertical")),fade:o.props.barFade,disabled:!!o.bodyHeight&&o.totalHeight<=o.bodyHeight,"bar-length":o.barLength,style:t.normalizeStyle({top:`${o.headHeight}px`}),onScroll:o.handleYBarScroll},null,8,["class","fade","disabled","bar-length","style","onScroll"])):t.createCommentVNode("",!0),o.props.rowDraggable?t.withDirectives((t.openBlock(),t.createElementBlock("div",{key:5,ref:"indicator",class:t.normalizeClass(o.nh.be("indicator"))},null,2)),[[t.vShow,o.indicatorShow]]):t.createCommentVNode("",!0)],14,ut)}var pt=nt(dt,[["render",mt]]);module.exports=pt;
