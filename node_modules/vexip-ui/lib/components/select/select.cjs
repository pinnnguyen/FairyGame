"use strict";var e=require("vue");require("../icon/index.cjs");require("../option/index.cjs");require("../portal/index.cjs");require("../tag/index.cjs");require("../virtual-list/index.cjs");require("../form/index.cjs");var F=require("@vexip-ui/hooks");require("../../common/config/src/index.cjs");var y=require("@vexip-ui/utils"),J=require("@vexip-ui/icons"),Qe=require("./props.cjs"),Ue=require("../../_virtual/plugin-vue_export-helper.cjs"),Ye=require("../icon/icon.cjs"),Ze=require("../option/option.cjs"),xe=require("../portal/portal.cjs"),_e=require("../tag/tag.cjs"),el=require("../virtual-list/virtual-list.cjs"),ll=require("../form/helper.cjs"),al=require("../../common/config/src/namespace.cjs"),h=require("../../common/config/src/props.cjs"),nl=require("../../common/config/src/locale/index.cjs");const tl={value:"value",label:"label",disabled:"disabled",divided:"divided",noTitle:"noTitle",group:"group",children:"children"};function ol(l,i){const T=Array.isArray(l),q=Array.isArray(i);if(T!==q)return!1;if(T&&q){if(l.length!==i.length)return!1;for(let N=0,P=l.length;N<P;++N)if(l[N]!==i[N])return!1;return!0}return y.isNull(l)?y.isNull(i):l===i}const sl=e.defineComponent({name:"Select",components:{Icon:Ye,Option:Ze,Portal:xe,Tag:_e,VirtualList:el,Check:J.Check,CircleXmark:J.CircleXmark,ChevronDown:J.ChevronDown},props:Qe.selectProps,emits:["update:value","update:visible","update:label"],setup(l,{emit:i,slots:T}){const{idFor:q,state:N,disabled:P,loading:B,size:Q,validateField:H,clearField:U,getFieldValue:Y,setFieldValue:K}=ll.useFieldStore(()=>{var a;return(a=x.value)==null?void 0:a.focus()}),m=al.useNameHelper("select"),n=h.useProps("select",l,{size:h.createSizeProp(Q),state:h.createStateProp(N),visible:{default:!1,static:!0},options:{default:()=>[],static:!0},disabled:()=>P.value,transitionName:()=>m.ns("drop"),outsideClose:!0,placeholder:null,prefix:null,prefixColor:"",suffix:null,suffixColor:"",noSuffix:!1,value:{default:()=>Y(null),static:!0},multiple:!1,clearable:!1,maxListHeight:300,listClass:null,placement:{default:"bottom",validator:a=>F.placementWhileList.includes(a)},transfer:!1,optionCheck:!1,emptyText:null,staticSuffix:!1,loading:()=>B.value,loadingIcon:J.Spinner,loadingLock:!1,loadingSpin:!1,keyConfig:()=>({}),filter:!1,ignoreCase:!1,creatable:!1,transparent:!1}),s=nl.useLocale("select"),p=e.ref(n.visible),f=e.ref([]),u=e.ref([]),g=e.ref(-1),ue=e.toRef(n,"placement"),Ne=e.toRef(n,"transfer"),Ee=e.ref(),pe=e.ref([]),z=e.ref(""),de=e.ref(0),w=e.ref([]),{isMounted:ze}=F.useMounted(),b=e.reactive({disabled:!1,divided:!1,noTitle:!1,value:"",label:"",group:!1,depth:0,parent:null,hidden:!1,hitting:!0,data:""}),W=e.reactive(new Set),I=e.computed(()=>w.value.concat(pe.value)),E=e.computed(()=>I.value.filter(a=>!a.hidden)),Le=e.computed(()=>({...tl,...n.keyConfig}));let V=new Map,c=n.value;const ce=e.ref(0);e.watchEffect(()=>{n.keyConfig.value,n.keyConfig.label,n.keyConfig.disabled,n.keyConfig.divided,n.keyConfig.noTitle,n.options,ce.value++}),e.watch(ce,$e,{immediate:!0});function $e(){var Be,we;const{value:a,label:o,disabled:r,divided:t,noTitle:d,group:v,children:S}=Le.value,G=V,te=new Map,Se=[],oe=n.options.map(k=>({option:k,depth:0,parent:null})).reverse();W.clear();for(const k of w.value)te.set(k.value,k),W.add(k.value);for(;oe.length;){const{option:k,depth:Ve,parent:Ke}=oe.pop(),D=typeof k=="string"?{[a]:k}:k,se=!!D[v],M=D[a];if(!se&&y.isNull(M))return;const We=D[o]||String(M),{[r]:Xe=!1,[t]:Re=!1,[d]:Ge=!1,[S]:ie=null}=D,$=G.get(D.value),re=e.reactive({disabled:Xe,divided:Re,noTitle:Ge,value:M,label:We,group:se,depth:Ve,parent:Ke,hidden:(Be=$==null?void 0:$.hidden)!=null?Be:!1,hitting:(we=$==null?void 0:$.hitting)!=null?we:!1,data:k});Se.push(re),se||(te.set(M,re),W.add(String(M))),Array.isArray(ie)&&ie.length&&oe.push(...ie.map(Je=>({option:Je,depth:Ve+1,parent:re})).reverse())}V=te,pe.value=Se,be(c)}const A=F.useClickOutside(Oe),C=e.ref(),Z=e.ref(),O=e.ref(),{reference:x,popper:_,transferTo:Fe,updatePopper:X}=F.usePopper({placement:ue,transfer:Ne,wrapper:A,isDrop:!0}),{isHover:fe}=F.useHover(x);F.useModifier({target:A,passive:!1,onKeyDown:(a,o)=>{if(!p.value){o.space&&(a.preventDefault(),a.stopPropagation(),ye());return}if(o.up||o.down){a.preventDefault(),a.stopPropagation();const r=E.value,t=r.length;if(!t)return;const d=o.down?1:-1;let v=(Math.max(-1,g.value+d)+t)%t,S=r[v];for(let G=0;(S.disabled||S.group)&&G<t;++G)v+=d,v=(v+t)%t,S=r[v];j(v),o.resetAll()}else o.enter?(a.preventDefault(),a.stopPropagation(),g.value>=0?R(me.value[g.value]):ee.value?R(b):p.value=!1,o.resetAll()):(o.tab||o.escape)&&(p.value=!1,o.resetAll())}});const Te=e.computed(()=>({[m.b()]:!0,[m.ns("input-vars")]:!0,[m.bs("vars")]:!0,[m.bm("inherit")]:n.inherit,[m.bm("multiple")]:n.multiple,[m.bm("filter")]:n.filter})),qe=e.computed(()=>{const a=m.be("selector");return{[a]:!0,[`${a}--focused`]:!n.disabled&&p.value,[`${a}--disabled`]:n.disabled,[`${a}--loading`]:n.loading&&n.loadingLock,[`${a}--${n.size}`]:n.size!=="default",[`${a}--${n.state}`]:n.state!=="default",[`${a}--has-prefix`]:he.value,[`${a}--has-suffix`]:!n.noSuffix,[`${a}--transparent`]:n.transparent}}),ve=e.computed(()=>!y.isNull(u.value[0])),he=e.computed(()=>!!(T.prefix||n.prefix)),ee=e.computed(()=>!!(n.filter&&n.creatable&&b.value&&!W.has(b.value))),me=e.computed(()=>ee.value?[b].concat(E.value):E.value),L=e.computed(()=>I.value.filter(a=>!a.group)),ge=e.computed(()=>{const a=L.value,o=new Map;for(let r=0,t=a.length;r<t;++r){const d=a[r];d.parent&&o.set(d.value,d.parent)}return o}),Ie=e.computed(()=>!n.disabled&&n.clearable&&fe.value&&ve.value);e.watch(()=>n.visible,a=>{p.value=a}),e.watch(p,a=>{a&&(Ce(),requestAnimationFrame(()=>{X(),A.value&&_.value&&(_.value.style.minWidth=`${A.value.offsetWidth}px`)}),setTimeout(()=>{O.value&&!y.isNull(u.value[0])&&O.value.ensureKeyInView(u.value[0])},32)),ne(),h.emitEvent(n.onToggle,a),i("update:visible",a)}),e.watch(()=>n.value,a=>{(!c||ol(a,c))&&(c=a,be(a))}),e.watch(()=>n.disabled,a=>{a&&(p.value=!1)}),e.watch(()=>n.loading,a=>{a&&n.loadingLock&&(p.value=!1)}),e.watch(()=>n.loadingLock,a=>{n.loading&&a&&(p.value=!1)}),e.watch(z,a=>{b.value=a,b.label=a,b.data=a,ae(a)}),e.onMounted(ne);function be(a){if(y.isNull(a)){u.value=[],f.value=[];return}const o=Array.isArray(a)?a:[a],r=new Set(o),t=[],d=[];r.forEach(v=>{const S=V.get(v);S&&(t.push(S.value),d.push(S.label))}),u.value=t,f.value=d,Ce(),ae(z.value)}function Ce(){const a=u.value[0];if(y.isNull(a))j(-1);else{if(!ze.value)return;j(E.value.findIndex(o=>o.value===a))}}function j(a,o=!0){g.value=a;let r=-1;E.value.forEach(t=>{t.hidden?t.hitting=!1:(r+=1,t.hitting=a===r)}),o&&p.value&&O.value&&O.value.ensureIndexInView(a)}function le(a){return n.multiple?u.value.includes(a.value):u.value[0]===a.value}function ae(a){const o=n.filter;if(!!o){if(!a)I.value.forEach(r=>{r.hidden=!1});else{if(I.value.forEach(t=>{t.hidden=!0}),typeof o=="function")L.value.forEach(t=>{t.hidden=!o(a,t)});else if(n.ignoreCase){const t=a.toString().toLocaleLowerCase();L.value.forEach(d=>{var v;d.hidden=!((v=d.value)!=null&&v.toString().toLocaleLowerCase().includes(t))})}else L.value.forEach(t=>{var d;t.hidden=!((d=t.value)!=null&&d.toString().includes(a==null?void 0:a.toString()))});const r=ge.value;L.value.forEach(t=>{if(!t.hidden&&t.parent){let d=r.get(t.value)||null;for(;d&&d.hidden;)d.hidden=!1,d=d.parent}})}j(g.value)}}function ke(a){R(V.get(a))}function R(a){if(!a)return;const o=le(a),r=a.value;if(o)w.value.find(t=>t.value===r)&&(y.removeArrayItem(w.value,t=>t.value===r),V.delete(r));else if(n.multiple||(w.value.length=0),b.value&&r===b.value){const t={...b};w.value.push(t),V.set(r,t)}h.emitEvent(n[n.multiple&&o?"onCancel":"onSelect"],r,a.data),Ae(a),n.multiple?(z.value="",ne(),X()):p.value=!1}function Ae(a){if(n.multiple){if(le(a)){const o=u.value.findIndex(r=>r===a.value);~o&&(u.value.splice(o,1),f.value.splice(o,1))}else u.value.push(a.value),f.value.push(a.label);c=Array.from(u.value),K(c),h.emitEvent(n.onChange,c,c.map(o=>{var r,t;return(t=(r=V.get(o))==null?void 0:r.data)!=null?t:""})),i("update:value",c),i("update:label",f.value),H()}else{const o=u.value[0];u.value.length=0,f.value.length=0,u.value.push(a.value),f.value.push(a.label),o!==a.value&&(c=a.value,K(c),h.emitEvent(n.onChange,c,a.data),i("update:value",c),i("update:label",f.value[0]),H())}}function ye(){n.disabled||n.loading&&n.loadingLock||(p.value=!p.value)}function Oe(){h.emitEvent(n.onClickOutside),n.outsideClose&&p.value&&(p.value=!1,h.emitEvent(n.onOutsideClose))}function je(){if(n.clearable){for(const a of w.value)V.delete(a.value);w.value.length=0,u.value.length=0,f.value.length=0,c=n.multiple?[]:"",h.emitEvent(n.onChange,c,n.multiple?[]:""),i("update:value",c),h.emitEvent(n.onClear),U(c),X()}}function De(a){h.emitEvent(n.onFocus,a)}function Me(a){h.emitEvent(n.onFocus,a)}function ne(){if(!C.value)return;const a=p.value;n.multiple?C.value.value="":C.value.value=a?"":f.value[0]||"",a?C.value.focus():C.value.blur()}function Pe(){!C.value||(z.value=C.value.value,ee.value||g.value!==-1?g.value=0:g.value=E.value.findIndex(a=>String(a.value)===z.value),requestAnimationFrame(()=>{n.multiple&&Z.value&&(de.value=y.getRangeWidth(Z.value)),X()}))}function He(a){!C.value||a.key==="Backspace"&&!C.value.value&&!y.isNull(u.value.at(-1))&&(a.stopPropagation(),ke(u.value.at(-1)))}return{props:n,nh:m,locale:s,idFor:q,currentVisible:p,currentValues:u,currentLabels:f,transferTo:Fe,listHeight:Ee,optionStates:I,isHover:fe,currentFilter:z,anchorWidth:de,className:Te,selectorClass:qe,hasValue:ve,hasPrefix:he,visibleOptions:E,totalOptions:me,showClear:Ie,normalOptions:L,optionParentMap:ge,wrapper:A,reference:x,popper:_,input:C,device:Z,virtualList:O,isSelected:le,filterOptions:ae,updateHitting:j,handleTagClose:ke,handleSelect:R,toggleVisible:ye,handleClear:je,handleFocus:De,handleBlur:Me,handleFilterInput:Pe,handleBackspace:He}}}),il=["id","aria-disabled"],rl=["disabled"],ul=["disabled","placeholder"],pl=["title"];function dl(l,i,T,q,N,P){const B=e.resolveComponent("Icon"),Q=e.resolveComponent("Tag"),H=e.resolveComponent("ChevronDown"),U=e.resolveComponent("CircleXmark"),Y=e.resolveComponent("Check"),K=e.resolveComponent("Option"),m=e.resolveComponent("VirtualList"),n=e.resolveComponent("Portal");return e.openBlock(),e.createElementBlock("div",{id:l.idFor,ref:"wrapper",class:e.normalizeClass(l.className),"aria-disabled":l.props.disabled?"true":void 0,onClick:i[8]||(i[8]=(...s)=>l.toggleVisible&&l.toggleVisible(...s))},[e.createElementVNode("div",{ref:"reference",class:e.normalizeClass(l.selectorClass),tabindex:"0",onFocus:i[4]||(i[4]=(...s)=>l.handleFocus&&l.handleFocus(...s)),onBlur:i[5]||(i[5]=(...s)=>l.handleBlur&&l.handleBlur(...s))},[l.hasPrefix?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass([l.nh.be("icon"),l.nh.be("prefix")]),style:e.normalizeStyle({color:l.props.prefixColor})},[e.renderSlot(l.$slots,"prefix",{},()=>[e.createVNode(B,{icon:l.props.prefix},null,8,["icon"])])],6)):e.createCommentVNode("",!0),e.createElementVNode("div",{class:e.normalizeClass(l.nh.be("control"))},[e.renderSlot(l.$slots,"control",{},()=>{var s,p,f;return[l.props.multiple?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(l.currentValues,(u,g)=>(e.openBlock(),e.createBlock(Q,{key:g,inherit:"",class:e.normalizeClass(l.nh.be("tag")),closable:"",onClick:e.withModifiers(l.toggleVisible,["stop"]),onClose:ue=>l.handleTagClose(u)},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(l.currentLabels[g]),1)]),_:2},1032,["class","onClick","onClose"]))),128)),l.props.filter?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(l.nh.be("anchor")),style:e.normalizeStyle({width:`${l.anchorWidth}px`})},[e.createElementVNode("input",{ref:"input",class:e.normalizeClass([l.nh.be("input"),l.nh.bem("input","multiple")]),disabled:l.props.disabled,autocomplete:"off",tabindex:"-1",role:"combobox","aria-autocomplete":"list",onInput:i[0]||(i[0]=(...u)=>l.handleFilterInput&&l.handleFilterInput(...u)),onKeydown:i[1]||(i[1]=(...u)=>l.handleBackspace&&l.handleBackspace(...u))},null,42,rl),e.createElementVNode("span",{ref:"device",class:e.normalizeClass(l.nh.be("device")),"aria-hidden":"true"},e.toDisplayString(l.currentFilter),3)],6)):e.createCommentVNode("",!0)],64)):(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[l.props.filter?(e.openBlock(),e.createElementBlock("input",{key:0,ref:"input",class:e.normalizeClass(l.nh.be("input")),disabled:l.props.disabled,placeholder:l.currentLabels[0]||((s=l.props.placeholder)!=null?s:l.locale.placeholder),autocomplete:"off",tabindex:"-1",role:"combobox","aria-autocomplete":"list",onInput:i[2]||(i[2]=(...u)=>l.handleFilterInput&&l.handleFilterInput(...u))},null,42,ul)):(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createTextVNode(e.toDisplayString(l.currentLabels[0]),1)],64))],64)),(l.props.multiple||!l.props.filter)&&(!l.currentVisible||!l.currentFilter)&&((p=l.props.placeholder)!=null?p:l.locale.placeholder)&&!l.hasValue?(e.openBlock(),e.createElementBlock("span",{key:2,class:e.normalizeClass(l.nh.be("placeholder"))},e.toDisplayString((f=l.props.placeholder)!=null?f:l.locale.placeholder),3)):e.createCommentVNode("",!0)]})],2),l.props.noSuffix?l.props.clearable||l.props.loading?(e.openBlock(),e.createElementBlock("div",{key:2,class:e.normalizeClass([l.nh.be("icon"),l.nh.bem("icon","placeholder"),l.nh.be("suffix")])},null,2)):e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",{key:1,class:e.normalizeClass([l.nh.be("icon"),l.nh.be("suffix")]),style:e.normalizeStyle({color:l.props.suffixColor,opacity:l.showClear||l.props.loading?"0%":""})},[e.renderSlot(l.$slots,"suffix",{},()=>[l.props.suffix?(e.openBlock(),e.createBlock(B,{key:0,icon:l.props.suffix,class:e.normalizeClass({[l.nh.be("arrow")]:!l.props.staticSuffix})},null,8,["icon","class"])):(e.openBlock(),e.createBlock(B,{key:1,class:e.normalizeClass(l.nh.be("arrow"))},{default:e.withCtx(()=>[e.createVNode(H)]),_:1},8,["class"]))])],6)),e.createVNode(e.Transition,{name:l.nh.ns("fade"),appear:""},{default:e.withCtx(()=>[l.showClear?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass([l.nh.be("icon"),l.nh.be("clear")]),onClick:i[3]||(i[3]=e.withModifiers((...s)=>l.handleClear&&l.handleClear(...s),["stop"]))},[e.createVNode(B,null,{default:e.withCtx(()=>[e.createVNode(U)]),_:1})],2)):l.props.loading?(e.openBlock(),e.createElementBlock("div",{key:1,class:e.normalizeClass([l.nh.be("icon"),l.nh.be("loading")])},[e.createVNode(B,{spin:l.props.loadingSpin,pulse:!l.props.loadingSpin,icon:l.props.loadingIcon},null,8,["spin","pulse","icon"])],2)):e.createCommentVNode("",!0)]),_:1},8,["name"])],34),e.createVNode(n,{to:l.transferTo},{default:e.withCtx(()=>[e.createVNode(e.Transition,{name:l.props.transitionName,onAfterLeave:i[7]||(i[7]=s=>l.currentFilter="")},{default:e.withCtx(()=>[l.currentVisible?(e.openBlock(),e.createElementBlock("div",{key:0,ref:"popper",class:e.normalizeClass([l.nh.be("popper"),l.nh.bs("vars"),l.transferTo!=="body"&&[l.nh.bem("popper","inherit")]]),onClick:i[6]||(i[6]=e.withModifiers(()=>{},["stop"]))},[e.createVNode(m,{ref:"virtualList",inherit:"",class:e.normalizeClass([l.nh.be("list"),l.props.listClass]),style:e.normalizeStyle({height:l.listHeight,maxHeight:`${l.props.maxListHeight}px`}),items:l.totalOptions,"item-size":32,"use-y-bar":"",height:"100%","id-key":"value","items-attrs":{class:[l.nh.be("options"),l.props.optionCheck?l.nh.bem("options","has-check"):""],role:"listbox",ariaLabel:"options"}},{default:e.withCtx(({item:s,index:p})=>[s.group?(e.openBlock(),e.createElementBlock("li",{key:0,class:e.normalizeClass([l.nh.ns("option-vars"),l.nh.be("group")]),title:s.label},[e.renderSlot(l.$slots,"group",{option:s,index:p},()=>[e.createElementVNode("div",{class:e.normalizeClass([l.nh.be("label"),l.nh.bem("label","group")]),style:e.normalizeStyle({paddingLeft:`${s.depth*6}px`})},e.toDisplayString(s.label),7)])],10,pl)):(e.openBlock(),e.createBlock(K,{key:1,label:s.label,value:s.value,disabled:s.disabled,divided:s.divided,"no-title":s.noTitle,hitting:s.hitting,selected:l.isSelected(s),"no-hover":"",onSelect:f=>l.handleSelect(s),onMousemove:f=>l.updateHitting(p,!1)},{default:e.withCtx(()=>[e.renderSlot(l.$slots,"default",{option:s,index:p,selected:l.isSelected(s)},()=>[e.createElementVNode("span",{class:e.normalizeClass(l.nh.be("label")),style:e.normalizeStyle({paddingLeft:`${s.depth*6}px`})},e.toDisplayString(s.label),7),l.props.optionCheck?(e.openBlock(),e.createBlock(e.Transition,{key:0,name:l.nh.ns("fade"),appear:""},{default:e.withCtx(()=>[l.isSelected(s)?(e.openBlock(),e.createBlock(B,{key:0,class:e.normalizeClass(l.nh.be("check"))},{default:e.withCtx(()=>[e.createVNode(Y)]),_:1},8,["class"])):e.createCommentVNode("",!0)]),_:2},1032,["name"])):e.createCommentVNode("",!0)])]),_:2},1032,["label","value","disabled","divided","no-title","hitting","selected","onSelect","onMousemove"]))]),empty:e.withCtx(()=>[e.createElementVNode("div",{class:e.normalizeClass(l.nh.be("empty"))},[e.renderSlot(l.$slots,"empty",{},()=>{var s;return[e.createTextVNode(e.toDisplayString((s=l.props.emptyText)!=null?s:l.locale.empty),1)]})],2)]),_:3},8,["class","style","items","items-attrs"])],2)):e.createCommentVNode("",!0)]),_:3},8,["name"])]),_:3},8,["to"])],10,il)}var cl=Ue(sl,[["render",dl]]);module.exports=cl;
