"use strict";var o=require("vue"),$e=require("./tree-node.cjs");require("../../common/config/src/index.cjs");var je=require("@vexip-ui/hooks"),v=require("@vexip-ui/utils"),Ve=require("./props.cjs"),T=require("./symbol.cjs"),ze=require("../../_virtual/plugin-vue_export-helper.cjs"),y=require("../../common/config/src/props.cjs"),Oe=require("../../common/config/src/namespace.cjs"),He=require("../../common/config/src/locale/index.cjs");const Ue={id:"id",parent:"parent",label:"label",children:"children",visible:"visible",selected:"selected",expanded:"expanded",disabled:"disabled",checked:"checked",loading:"loading",loaded:"loaded",readonly:"readonly",arrow:"arrow",checkbox:"checkbox"},Ye=o.defineComponent({name:"Tree",components:{TreeNode:$e},props:Ve.treeProps,emits:[],setup(c){const r=y.useProps("tree",c,{arrow:{default:"auto",validator:e=>typeof e=="boolean"||e==="auto"},data:{default:()=>[],static:!0},noBuildTree:!1,emptyTip:null,disabled:!1,readonly:!1,checkbox:!1,suffixCheckbox:!1,renderer:{default:null,isFunc:!0},multiple:!1,indent:"16px",accordion:!1,draggable:!1,appear:!1,floorSelect:!1,onAsyncLoad:{default:null,isFunc:!0},cacheNode:!1,rootId:null,keyConfig:()=>({}),noCascaded:!1,filter:"",ignoreCase:!1,nodeProps:null}),q=Oe.useNameHelper("tree"),h=new Map,D=o.ref([]),P=o.ref(!1),K=o.ref(!1),s=o.ref(!1),{isMounted:S}=je.useMounted(),w=o.ref(),$=o.ref(),A=o.ref();let x=[];const re={visible:!0,selected:!1,expanded:!1,disabled:!1,checked:!1,loading:!1,loaded:!1,readonly:!1,arrow:"auto",checkbox:null},m=o.computed(()=>({...Ue,...r.keyConfig})),j=o.computed(()=>({keyField:m.value.id,childField:m.value.children,parentField:m.value.parent,rootId:r.rootId})),ee=o.computed(()=>typeof r.onAsyncLoad=="function"),g=o.computed(()=>v.flatTree(D.value,{keyField:"id",parentField:"parent",childField:"children",rootId:r.rootId})),te=o.computed(()=>m.value.label);function le(e){const t=r.ignoreCase?String(e).toLocaleLowerCase():e;return a=>{const d=a[te.value];return r.ignoreCase?String(d).toLocaleLowerCase().includes(t):String(d).includes(t)}}o.watchEffect(()=>{const e=g.value;if(r.filter){const t=typeof r.filter=="function"?r.filter:le(r.filter);s.value=!1;for(let n=0,a=e.length;n<a;++n){const d=e[n],l=h.get(d.parent);if(d.matched=t(d.data,d),d.childMatched=!1,d.upperMatched=!!l&&(l.matched||l.upperMatched),s.value=s.value||d.matched,d.matched){let i=l;for(;i&&!i.childMatched;)i.childMatched=!0,i=h.get(i.parent)}}}else{for(let t=0,n=e.length;t<n;++t){const a=e[t];a.matched=!0,a.childMatched=!1,a.upperMatched=!1}s.value=!0}}),o.provide(T.TREE_STATE,o.reactive({arrow:o.toRef(r,"arrow"),checkbox:o.toRef(r,"checkbox"),suffixCheckbox:o.toRef(r,"suffixCheckbox"),renderer:o.toRef(r,"renderer"),dragging:P,boundAsyncLoad:ee,updateVisibleNodeEls:F,computeCheckedState:pe,handleNodeClick:ue,handleNodeSelect:he,handleNodeCancel:ge,handleNodeExpand:ve,handleNodeReduce:ye,handleAsyncLoad:be,handleNodeDragStart:ke,handleNodeDragOver:me,handleNodeDrop:we,handleNodeDragEnd:xe,handleHittingChange:Ce,handleNodeHitting:Ee,handleLabelClick:fe})),o.provide(T.TREE_NODE_STATE,o.reactive({depth:-1,disabled:o.toRef(r,"disabled"),readonly:o.toRef(r,"readonly")})),o.watch([()=>r.data,()=>r.data.length],L),o.watch(j,L),L(),o.onMounted(F);const ne=g.value.filter(e=>e.checked);for(let e=0,t=ne.length;e<t;++e){const n=ne[e],a=n.parent;O(n),a&&h.has(a)&&(h.get(a).checked||z(n))}function F(){requestAnimationFrame(()=>{w.value&&(x=v.queryAll(`.${q.be("node")}`,w.value))})}function L(){var i;const e=m.value.id,t=m.value.parent,n=new Map,a=new Map;for(const u of h.values())n.set(u.data,u),a.set(u.data[e],u);h.clear();const d=[],l=r.noBuildTree?v.flatTree(r.data,j.value):r.data;for(let u=0,N=l.length;u<N;++u){const f=l[u],b=(i=n.get(f))!=null?i:a.get(f[e]),k=r.cacheNode?b!=null?b:V(f):V(f,b);k.parent=f[t],k.data=f,h.set(k.id,k),d.push(k)}D.value=v.transformTree(d,{keyField:"id",parentField:"parent",childField:"children",rootId:r.rootId}),S.value&&F()}function ie(){const e=[],t=r.noBuildTree?v.flatTree(r.data,j.value):r.data,{id:n,visible:a,selected:d,expanded:l,disabled:i,checked:u,loading:N,loaded:f,readonly:b,arrow:k,checkbox:H}=m.value;for(let B=0,U=t.length;B<U;++B){const M=t[B],I=M[n];let p;if(h.has(I)){p=h.get(I);const{[a]:Y=p.visible,[d]:G=p.selected,[l]:J=p.expanded,[i]:Q=p.disabled,[u]:W=p.checked,[N]:X=p.loading,[f]:Z=p.loaded,[b]:_=p.readonly,[k]:Le=p.arrow,[H]:qe=p.checkbox}=M;p.visible=Y,p.selected=G,p.expanded=J,p.disabled=Q,p.checked=W,p.loading=X,p.loaded=Z,p.readonly=_,p.arrow=Le,p.checkbox=qe}else p=V(M),h.set(I,p);e.push(p)}D.value=v.transformTree(e,{keyField:"id",parentField:"parent",childField:"children",rootId:r.rootId}),S.value&&F()}function ce(){g.value.forEach(e=>{if(!e.data)return;const{data:t,visible:n,selected:a,expanded:d,disabled:l,checked:i,loading:u,readonly:N}=e;t.visible=n,t.selected=a,t.expanded=d,t.disabled=l,t.checked=i,t.loading=u,t.readonly=N}),S.value&&F()}function V(e,t=re){const{id:n,parent:a,visible:d,selected:l,expanded:i,disabled:u,checked:N,loading:f,loaded:b,readonly:k,arrow:H,checkbox:B}=m.value,{[d]:U=t.visible,[l]:M=t.selected,[i]:I=t.expanded,[u]:p=t.disabled,[N]:Y=t.checked,[f]:G=t.loading,[b]:J=t.loaded,[k]:Q=t.readonly,[H]:W=t.arrow,[B]:X=t.checkbox}=e,Z=e[n],_=e[a];return o.reactive({id:Z,parent:_,children:[],data:e,visible:U,selected:M,expanded:I,disabled:p,checked:Y,loading:G,loaded:J,readonly:Q,arrow:W,checkbox:X,partial:!1,matched:!1,childMatched:!1,upperMatched:!1})}function se(e){return e.children}function z(e){let t=e;for(;!v.isNull(t.parent);){const n=t.parent;if(!h.has(n))break;const a=h.get(n);if(t.checked===a.checked&&t.partial===a.partial)break;t.checked?(a.checked=a.children.every(d=>d.checked),a.partial=!a.checked):(a.checked=!1,a.partial=a.children.some(d=>d.checked||d.partial)),t=a}}function O(e){const t=e.checked,n=e.partial,a=[...e.children];let d;for(;a.length;)d=a.shift(),!d.disabled&&(d.checked=t,d.partial=n,d.children.length&&a.push(...d.children))}function pe(e,t){if(!r.noCascaded){const n=[e].concat(g.value.filter(a=>a.disabled&&a.checked));for(let a=0,d=n.length;a<d;++a){const l=n[a];z(l),O(l)}}y.emitEvent(r.onNodeChange,e.data,e,t)}function ue(e){y.emitEvent(r.onNodeClick,e.data,e)}function fe(e){y.emitEvent(r.onLabelClick,e.data,e)}function he(e){const t=g.value.filter(n=>n.selected);if(r.multiple)y.emitEvent(r.onNodeSelect,t.map(n=>n.data),t);else{const n=e.id;for(let a=0,d=t.length;a<d;++a){const l=t[a];l.selected=l.id===n}y.emitEvent(r.onNodeSelect,e.data,e)}}function ge(e){y.emitEvent(r.onNodeCancel,e.data,e)}function ve(e){if(r.accordion){const t=oe(e);for(let n=0,a=t.length;n<a;++n)t[n].expanded=!1}y.emitEvent(r.onNodeExpand,e.data,e)}function ye(e){y.emitEvent(r.onNodeReduce,e.data,e)}async function be(e){if(!ee.value)return!1;let t=r.onAsyncLoad(e.data,e);return v.isPromise(t)&&(t=await t),t!==!1}let E=null;function ke(e){!w.value||(E={draggingNode:e.node,treeRect:w.value.getBoundingClientRect(),willDropNode:null,dropType:T.DropType.BEFORE},P.value=!0,y.emitEvent(r.onDragStart,e.node.data,e.node))}function me(e,t){if(!E||!e.el||!e.arrow)return;const n=e.el.getBoundingClientRect(),a=E.treeRect,d=e.arrow.getBoundingClientRect(),l=.25,i=.75,u=t.clientY-n.top,N=d.height;let f,b=-9999,k=!0;u<N*l?(f=T.DropType.BEFORE,b=d.top-a.top):u>N*i?(f=T.DropType.AFTER,b=d.bottom-a.top):(f=T.DropType.INNER,k=!1),A.value&&(A.value.style.top=`${b}px`,A.value.style.left=`${d.right-a.left}px`),E.willDropNode=e.node,E.dropType=f,K.value=k,y.emitEvent(r.onDragOver,e.node.data,e.node)}function Ne(e,t){if(!e||!t)return!0;for(;e;){if(e===t||e.id===t.id)return!0;e=C(e)}return!1}function we(e){if(!E)return;const{draggingNode:t,willDropNode:n,dropType:a}=E;if(!n||Ne(n,t))return;let d,l;if(t&&(l=C(t),l||(l={children:D.value}),d=t.id,v.removeArrayItem(l.children,i=>i.id===d)),a===T.DropType.INNER){Array.isArray(n.children)||(n.children=[]);const i=Array.from(n.children);i.push(t),n.children=i,t.parent=n.id}else{l=C(n),l||(l={parent:void 0,children:D.value}),d=n.id;const i=l.children.findIndex(u=>u.id===d);~i&&(l.children.splice(+(a===T.DropType.AFTER)+i,0,t),t.parent=l.id)}y.emitEvent(r.onDrop,e.node.data,e.node,a)}function xe(e){P.value=!0,K.value=!1,E=null,y.emitEvent(r.onDragEnd,e.node.data,e.node)}function Ce(e){var a;const t=document.activeElement;if(!x.length||!t)return;const n=x.findIndex(d=>d===t);~n&&((a=x.at((n+(e==="up"?-1:1))%x.length))==null||a.focus())}function Ee(e){!e||!x.length||x.includes(e)&&e.focus()}function Te(e){const t=e.target;!x.length||!t||!$.value||t===$.value&&x[0].focus()}function ae(){return g.value.filter(e=>e.checked)}function De(){return ae().map(e=>e.data)}function de(){return g.value.filter(e=>e.selected)}function Ke(){return de().map(e=>e.data)}function Se(){return g.value.filter(e=>e.expanded)}function Fe(){return g.value.filter(e=>e.disabled)}function C(e){var t;return e.parent&&(t=h.get(e.parent))!=null?t:null}function oe(e,t=!1){const n=C(e),a=e.id,d=n?n.id:null;return g.value.filter(l=>{const i=d===null?!l.parent:l.parent===d;return i&&!t?l.id!==a:i})}function Re(e){const t=C(e);if(!t)return null;const n=e.id,a=t.id,d=g.value.filter(l=>l.parent===a);if(d&&d.length){const l=d.findIndex(i=>i.id===n);if(l>0)return d[l-1]}return null}function Be(e){const t=C(e);if(!t)return null;const n=e.id,a=t.id,d=g.value.filter(l=>l.parent===a);if(d&&d.length){const l=d.findIndex(i=>i.id===n);if(!~l&&l<d.length-1)return d[l+1]}return null}function R(e){var n;const t=m.value.id;return(n=g.value.find(a=>a.data[t]===e[t]))!=null?n:null}function Me(e,t,n=!1){const a=R(e);if(a&&(a.expanded=v.isNull(t)?!a.expanded:!!t,n)){let d=C(a);for(;d;)d.expanded=a.expanded,d=C(d)}}function Ie(e,t){const n=R(e);n&&(n.selected=v.isNull(t)?!n.selected:!!t)}function Pe(e,t){const n=R(e);if(n&&(n.checked=v.isNull(t)?!n.checked:!!t,!r.noCascaded)){const a=[n].concat(g.value.filter(d=>d.disabled&&d.checked));for(let d=0,l=a.length;d<l;++d){const i=a[d];z(i),O(i)}}}function Ae(e,t){const n=R(e);n&&(n.checked=v.isNull(t)?!n.loading:!!t)}return{props:r,nh:q,locale:He.useLocale("tree"),treeData:D,indicatorShow:K,anyMatched:s,labelKey:te,childrenKey:o.computed(()=>m.value.children),getNodeProps:o.computed(()=>typeof r.nodeProps=="function"?r.nodeProps:()=>r.nodeProps),wrapper:w,trap:$,indicator:A,handleTreeFocus:Te,parseAndTransformData:L,forceUpdateData:ie,syncNodeStateIntoData:ce,getCheckedNodes:ae,getCheckedNodeData:De,getSelectedNodes:de,getSelectedNodeData:Ke,getExpandedNodes:Se,getDisabledNodes:Fe,getNodeChildren:se,getParentNode:C,getSiblingNodes:oe,getPrevSiblingNode:Re,getNextSiblingNode:Be,getNodeByData:R,expandNodeByData:Me,selectNodeByData:Ie,checkNodeByData:Pe,toggleNodeLoadingByData:Ae}}}),Ge=["aria-disabled","aria-readonly"];function Je(c,r,q,h,D,P){const K=o.resolveComponent("TreeNode");return o.openBlock(),o.createElementBlock("div",{ref:"wrapper",class:o.normalizeClass([c.nh.b(),c.nh.bs("vars"),c.props.inherit&&c.nh.bm("inherit")]),role:"tree",tabindex:"-1","aria-disabled":c.props.disabled,"aria-readonly":c.props.readonly},[o.createElementVNode("span",{ref:"trap",tabindex:"0","aria-hidden":"true",style:{width:"0",height:"0",overflow:"hidden",outline:"none"},onFocus:r[0]||(r[0]=(...s)=>c.handleTreeFocus&&c.handleTreeFocus(...s))},null,544),o.createElementVNode("ul",{class:o.normalizeClass(c.nh.be("list"))},[(o.openBlock(!0),o.createElementBlock(o.Fragment,null,o.renderList(c.treeData,(s,S)=>(o.openBlock(),o.createBlock(K,o.mergeProps({key:S},c.getNodeProps(s.data,s),{node:s,data:s.data,arrow:s.arrow,checkbox:s.checkbox,appear:c.props.appear,visible:s.visible,selected:s.selected,expanded:s.expanded,disabled:s.disabled,"label-key":c.labelKey,checked:s.checked,loading:s.loading,loaded:s.loaded,partial:s.partial,readonly:s.readonly,indent:c.props.indent,draggable:c.props.draggable,"floor-select":c.props.floorSelect,matched:s.matched,"child-matched":s.childMatched,"upper-matched":s.upperMatched,"node-props":c.getNodeProps}),{default:o.withCtx(w=>[o.renderSlot(c.$slots,"node",o.normalizeProps(o.guardReactiveProps(w)))]),label:o.withCtx(w=>[o.renderSlot(c.$slots,"label",o.normalizeProps(o.guardReactiveProps(w)))]),_:2},1040,["node","data","arrow","checkbox","appear","visible","selected","expanded","disabled","label-key","checked","loading","loaded","partial","readonly","indent","draggable","floor-select","matched","child-matched","upper-matched","node-props"]))),128))],2),!c.props.data||!c.props.data.length||!c.anyMatched?(o.openBlock(),o.createElementBlock("div",{key:0,class:o.normalizeClass(c.nh.be("empty-tip"))},[o.renderSlot(c.$slots,"empty",{},()=>{var s;return[o.createTextVNode(o.toDisplayString((s=c.props.emptyTip)!=null?s:c.locale.empty),1)]})],2)):o.createCommentVNode("",!0),c.props.draggable?o.withDirectives((o.openBlock(),o.createElementBlock("div",{key:1,ref:"indicator",class:o.normalizeClass(c.nh.be("indicator"))},null,2)),[[o.vShow,c.indicatorShow]]):o.createCommentVNode("",!0)],10,Ge)}var Qe=ze(Ye,[["render",Je]]);module.exports=Qe;
