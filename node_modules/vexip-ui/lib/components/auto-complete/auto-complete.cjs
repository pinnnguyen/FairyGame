"use strict";var o=require("vue");require("../icon/index.cjs");require("../select/index.cjs");require("../form/index.cjs");var Q=require("@vexip-ui/hooks");require("../../common/config/src/index.cjs");var I=require("@vexip-ui/utils"),X=require("./props.cjs"),Y=require("../../_virtual/plugin-vue_export-helper.cjs"),Z=require("../icon/icon.cjs"),x=require("../select/select.cjs"),_=require("../form/helper.cjs"),ee=require("../../common/config/src/namespace.cjs"),v=require("../../common/config/src/props.cjs"),le=require("../../common/config/src/locale/index.cjs");const oe=o.defineComponent({name:"AutoComplete",components:{Icon:Z,Select:x},props:X.autoCompleteProps,emits:["update:value"],setup(e,{slots:p,emit:D}){const g=o.ref(),s=o.ref(),{idFor:L,state:b,disabled:V,loading:f,size:t,validateField:j,clearField:A,getFieldValue:O,setFieldValue:T}=_.useFieldStore(()=>{var l;return(l=s.value)==null?void 0:l.focus()}),N=ee.useNameHelper("auto-complete"),i=v.useProps("autoComplete",e,{size:v.createSizeProp(t),state:v.createStateProp(b),transfer:!1,value:{default:()=>O(""),static:!0},options:{default:()=>[],static:!0},filter:!1,prefix:null,prefixColor:"",suffix:null,suffixColor:"",placeholder:null,disabled:()=>V.value,transitionName:()=>N.ns("drop"),dropDisabled:!1,placement:{default:"bottom",validator:l=>Q.placementWhileList.includes(l)},clearable:!1,ignoreCase:!1,autofocus:!1,spellcheck:!1,keyConfig:()=>({}),loading:()=>f.value,loadingIcon:null,loadingLock:!1,loadingSpin:!1,transparent:!1}),u=o.ref(i.value),d=o.ref(-1),c=o.ref(!1);let C=!1,h=i.value,w=String(h);const k=o.computed(()=>{var l;return((l=g.value)==null?void 0:l.optionStates)||[]}),E=o.computed(()=>{var l;return((l=g.value)==null?void 0:l.normalOptions)||[]}),y=o.computed(()=>{var l;return((l=g.value)==null?void 0:l.visibleOptions)||[]}),K=o.computed(()=>!!(p.prefix||i.prefix)),M=o.computed(()=>!!(p.suffix||i.suffix)),B=o.computed(()=>{var l;return((l=g.value)==null?void 0:l.optionParentMap)||new Map});o.watch(()=>i.value,l=>{u.value=l,h=l,w=String(l),s.value&&(s.value.value=String(l))}),o.watch(d,P),o.watch(c,l=>{var a,n;l?(n=s.value)==null||n.focus():(d.value=-1,(a=s.value)==null||a.blur())}),o.watchEffect(()=>{if(i.filter){const l=u.value;if(I.isNull(l))k.value.forEach(a=>{a.hidden=!1});else{if(k.value.forEach(n=>{n.hidden=!0}),typeof i.filter=="function"){const n=i.filter;E.value.forEach(r=>{r.hidden=!n(l,r)})}else if(i.ignoreCase){const n=l==null?void 0:l.toString().toLocaleLowerCase();E.value.forEach(r=>{var S;r.hidden=!((S=r.value)!=null&&S.toString().toLocaleLowerCase().includes(n))})}else E.value.forEach(n=>{var r;n.hidden=!((r=n.value)!=null&&r.toString().includes(l==null?void 0:l.toString()))});const a=B.value;E.value.forEach(n=>{if(!n.hidden&&n.parent){let r=a.get(n.value)||null;for(;r&&r.hidden;)r.hidden=!1,r=r.parent}})}P()}}),o.onMounted(()=>{o.nextTick(()=>{s.value&&!I.isNull(u.value)&&(s.value.value=String(u.value))})});function P(){const l=d.value;let a=-1;k.value.forEach(n=>{n.hidden?n.hitting=!1:(a+=1,n.hitting=l===a,n.hitting&&s.value&&(s.value.value=String(n.value)))}),s.value&&l<0&&(s.value.value=w)}function z(l,a){if(I.isNull(l))return;const n=u.value;u.value=l,v.emitEvent(i.onSelect,l,a),l!==n?(C=!0,q()):c.value=!1}function H(l){const a=typeof l=="string"?l:l.target.value;c.value=!i.dropDisabled,u.value=a,C=!0,w=a,d.value!==-1&&(d.value=0),v.emitEvent(i.onInput,a)}function q(){if(!C||u.value===h)return;C=!1,h=u.value,w=String(h);const l=k.value.find(a=>a.value===h);T(u.value),v.emitEvent(i.onChange,u.value,(l==null?void 0:l.data)||null),D("update:value",u.value),j(),c.value=!1,s.value&&(s.value.value=String(h),s.value.blur())}function U(){R(),v.emitEvent(i.onToggle,c.value),c.value||(d.value=-1)}function R(){(!y.value.length||i.dropDisabled)&&(c.value=!1)}function W(l){const a=l.code||l.key;if(a==="ArrowDown"||a==="ArrowUp"){l.preventDefault(),l.stopPropagation();const n=y.value,r=n.length;if(!r)return;const S=a==="ArrowDown"?1:-1;let m=(d.value+S)%r,$=n[m];for(let F=0;($.disabled||$.group)&&F<r;++F)m+=S,m=(m+r)%r,$=n[m];d.value=m}else["Space"," "].includes(a)&&l.stopPropagation(),["Enter","ArrowLeft","ArrowRight"].includes(a)||(d.value=-1)}function G(){var l;if(y.value.length){const a=y.value[d.value===-1?0:d.value];z(a.value,a.data)}else q();v.emitEvent(i.onEnter,u.value),(l=s.value)==null||l.blur(),c.value=!1}function J(){if(i.clearable){const l=u.value;u.value="",c.value=!1,!I.isNull(l)&&l!==u.value&&(C=!0),q(),v.emitEvent(i.onClear),o.nextTick(A)}}return{props:i,nh:N,locale:le.useLocale("input"),idFor:L,currentValue:u,currentIndex:d,visible:c,hasPrefix:K,hasSuffix:M,select:g,control:s,handleSelect:z,handleInput:H,handleChange:q,handleToggle:U,handleKeyDown:W,handleEnter:G,handleClear:J}}}),ne=["autofocus","spellcheck","disabled","placeholder","readonly"];function ae(e,p,D,g,s,L){const b=o.resolveComponent("Icon"),V=o.resolveComponent("Select");return o.openBlock(),o.createBlock(V,{id:e.idFor,ref:"select",visible:e.visible,"onUpdate:visible":p[3]||(p[3]=f=>e.visible=f),class:o.normalizeClass(e.nh.b()),inherit:e.props.inherit,"list-class":e.nh.be("list"),value:e.currentValue,size:e.props.size,state:e.props.state,clearable:e.props.clearable,"transition-name":e.props.transitionName,disabled:e.props.disabled,transfer:e.props.transfer,placement:e.props.placement,"prefix-color":e.props.prefixColor,"suffix-color":e.props.suffixColor,"no-suffix":!e.hasSuffix,placeholder:e.props.placeholder,options:e.props.options,"key-config":e.props.keyConfig,loading:e.props.loading,"loading-icon":e.props.loadingIcon,"loading-lock":e.props.loadingLock,"loading-spin":e.props.loadingSpin,transparent:e.transparent,onToggle:e.handleToggle,onSelect:e.handleSelect,onClear:e.handleClear,onFocus:p[4]||(p[4]=f=>{var t;return(t=e.control)==null?void 0:t.focus()}),onBlur:p[5]||(p[5]=f=>{var t;return(t=e.control)==null?void 0:t.blur()}),onOutsideClose:e.handleChange},o.createSlots({control:o.withCtx(()=>[o.renderSlot(e.$slots,"control",{value:e.currentValue,onInput:e.handleInput,onChange:e.handleChange,onEnter:e.handleEnter,onClear:e.handleClear},()=>{var f;return[o.createElementVNode("input",{ref:"control",class:o.normalizeClass(e.nh.be("input")),autofocus:e.props.autofocus,spellcheck:e.props.spellcheck,disabled:e.props.disabled,placeholder:(f=e.props.placeholder)!=null?f:e.locale.placeholder,readonly:e.props.loading&&e.props.loadingLock,autocomplete:"off",tabindex:"-1",role:"combobox","aria-autocomplete":"list",onInput:p[0]||(p[0]=(...t)=>e.handleInput&&e.handleInput(...t)),onKeydown:[p[1]||(p[1]=o.withKeys((...t)=>e.handleEnter&&e.handleEnter(...t),["enter"])),p[2]||(p[2]=(...t)=>e.handleKeyDown&&e.handleKeyDown(...t))]},null,42,ne)]})]),default:o.withCtx(({option:f,index:t,selected:j})=>[o.renderSlot(e.$slots,"default",{option:f,index:t,selected:j})]),group:o.withCtx(({option:f,index:t})=>[o.renderSlot(e.$slots,"group",{option:f,index:t})]),_:2},[e.hasPrefix?{name:"prefix",fn:o.withCtx(()=>[o.renderSlot(e.$slots,"prefix",{},()=>[o.createVNode(b,{icon:e.props.prefix},null,8,["icon"])])]),key:"0"}:void 0,e.hasSuffix?{name:"suffix",fn:o.withCtx(()=>[o.renderSlot(e.$slots,"suffix",{},()=>[o.createVNode(b,{icon:e.props.suffix},null,8,["icon"])])]),key:"1"}:void 0]),1032,["id","visible","class","inherit","list-class","value","size","state","clearable","transition-name","disabled","transfer","placement","prefix-color","suffix-color","no-suffix","placeholder","options","key-config","loading","loading-icon","loading-lock","loading-spin","transparent","onToggle","onSelect","onClear","onOutsideClose"])}var re=Y(oe,[["render",ae]]);module.exports=re;
