"use strict";var l=require("vue");require("../button/index.cjs");require("../icon/index.cjs");require("../upload-list/index.cjs");require("../form/index.cjs");require("../../common/config/src/index.cjs");var v=require("@vexip-ui/utils"),D=require("@vexip-ui/icons"),we=require("./props.cjs"),De=require("./request.cjs"),c=require("./symbol.cjs"),O=require("../button/button.cjs"),F=require("../icon/icon.cjs"),G=require("./upload-list.cjs"),Fe=require("../form/helper.cjs"),g=require("../../common/config/src/props.cjs"),xe=require("../../common/config/src/namespace.cjs"),Ce=require("../../common/config/src/locale/index.cjs");function Le(){return{id:v.randomString(),name:"",size:0,type:"",base64:null,status:c.StatusType.PENDING,percentage:0,source:null,url:null,path:"",xhr:null,response:null,error:null}}var Ne=l.defineComponent({name:"Upload",components:{Button:O,Icon:F,UploadList:G,CloudArrowUp:D.CloudArrowUp},props:we.uploadProps,emits:["update:file-list"],setup(R,{slots:h,emit:M,expose:H}){const{idFor:K,state:J,disabled:Q,loading:W,size:X,validateField:Y,getFieldValue:Z,setFieldValue:_}=Fe.useFieldStore(()=>{var t,a;(t=P.value)!=null&&t.$el?P.value.$el.focus():(a=j.value)==null||a.focus()}),e=g.useProps("upload",R,{state:g.createStateProp(J),url:{default:"",static:!0},fileList:{default:()=>Z([]),static:!0},multiple:!1,tip:"",accept:null,filter:"",maxSize:{default:null,validator:t=>t>=0},field:"file",data:()=>({}),headers:()=>({}),withCredentials:!1,manual:!1,hiddenFiles:!1,countLimit:{default:0,validator:t=>t>=0},allowDrag:!1,onBeforeUpload:{default:null,isFunc:!0},onBeforeSelect:{default:null,isFunc:!0},iconRenderer:{default:null,isFunc:!0},selectToAdd:!1,listType:{default:"name",validator:t=>c.uploadListTypes.includes(t)},block:!1,loadingText:null,directory:!1,pathField:"path",disabledClick:!1,buttonLabel:null,disabled:()=>Q.value,loading:()=>W.value,loadingIcon:D.Spinner,loadingLock:!1,loadingSpin:!1,defaultFiles:()=>[],listStyle:null}),i=xe.useNameHelper("upload"),N=Ce.useLocale("upload"),d=l.ref([]),E=l.ref(!1),x=l.ref(),P=l.ref(),j=l.ref(),ee=l.computed(()=>[i.b(),i.bs("vars"),i.bm(`type-${e.listType}`),{[i.bm("inherit")]:e.inherit,[i.bm(e.state)]:e.state!=="default",[i.bm("multiple")]:e.multiple,[i.bm("drag")]:e.allowDrag,[i.bm("to-add")]:e.selectToAdd,[i.bm("block")]:e.block,[i.bm("drag-only")]:e.disabledClick,[i.bm("image")]:e.image,[i.bm("has-file")]:!e.hiddenFiles&&k.value.length}]),te=l.computed(()=>e.image?{[i.be("image-control")]:!0,[i.bem("image-control","drag-over")]:E.value,[i.bem("image-control","disabled")]:e.disabled}:{[i.be("control")]:!0,[i.bem("control","drag-over")]:E.value}),ae=l.computed(()=>{if(e.image)return"image/*";const t=e.accept;return t&&(typeof t=="string"?t:t.join())}),ne=l.computed(()=>e.defaultFiles.map(t=>q(t))),k=l.computed(()=>ne.value.concat(d.value).filter(t=>t.status!==c.StatusType.DELETE));l.watch(()=>e.fileList,t=>{const a=new Map,r=new Map;for(const n of d.value)v.isDefined(n.id)&&a.set(n.id,n),n.source&&r.set(n.source,n);d.value=(t||[]).map(n=>q(n,n.id?a.get(n.id):n.source?r.get(n.source):void 0)),V()},{immediate:!0,deep:!0}),H({execute:I,handleDelete:B});function z(){var t;!e.disabledClick&&((t=x.value)==null||t.click())}function le(t){const a=t.code||t.key;(a==="Enter"||a==="Space")&&z()}function ie(t){const a=t.target;a!=null&&a.files&&U(a.files)}async function U(t){const a=Array.from(t||[]),n=e.selectToAdd?Array.from(d.value):[];for(const o of a){o.path||(o.path=o.webkitRelativePath);let p=re(o);if(p?p.status!==c.StatusType.SUCCESS&&p.status!==c.StatusType.UPLOADING&&(p.status=c.StatusType.PENDING):p=q({name:o.name,size:o.size,type:o.type,source:o}),typeof e.onBeforeSelect=="function"){let s=e.onBeforeSelect(p,n);if(v.isPromise(s)&&(s=await s),v.isFalse(s))continue}n.includes(p)||n.push(p)}const u=e.countLimit;if(u>0&&n.length>u){const o=n.slice(u);g.emitEvent(e.onExceed,o),d.value=n.slice(0,u)}else d.value=n;V(),T(),e.manual||I()}function T(){_(d.value),g.emitEvent(e.onChange,d.value),M("update:file-list",d.value),Y()}function re(t){const{name:a,size:r,type:n}=t,u=t.path||t.webkitRelativePath;return d.value.find(({source:o})=>o&&(o.path||o.webkitRelativePath)===u&&o.name===a&&o.size===r&&o.type===n)}function q(t,a=Le()){var b;const{id:r,name:n,size:u,type:o,base64:p,status:s,percentage:y,source:f,url:L,path:m}=t;return Object.assign(a,{id:(b=r!=null?r:a.id)!=null?b:v.randomString(),name:n||"",size:u||0,type:o||"",base64:p||null,status:s!=null?s:c.StatusType.PENDING,percentage:y||0,source:f||null,url:L||null,path:m||"",xhr:null,response:null,error:null}),a}function oe(t){return t.name.split(".").pop().toLocaleLowerCase()}async function I(){if(!e.url||!ue())return!1;const t=d.value.filter(r=>r.status!==c.StatusType.SUCCESS&&r.status!==c.StatusType.DELETE),a=[];for(const r of t)a.push(se(r).catch(v.noop));return await Promise.all(a).then(r=>r.filter(n=>n))}async function se(t){if(typeof e.onBeforeUpload=="function"){let s=e.onBeforeUpload(t,d.value.filter(y=>y.status!==c.StatusType.SUCCESS&&y.status!==c.StatusType.DELETE));if(v.isPromise(s))try{s=await s}catch{return}if(v.isFalse(s))return;s instanceof Blob&&(s instanceof File?t.source=s:t.source=new File([s],t.name,{type:t.type}))}if(!t.source)return;t.status=c.StatusType.UPLOADING;const{url:a,headers:r,withCredentials:n,data:u,field:o,pathField:p}=e;return await new Promise((s,y)=>{t.xhr=De.upload({url:a,headers:r,withCredentials:n,data:u,field:o,pathField:p,file:t.source,onProgress:f=>{de(f,t)},onSuccess:f=>{pe(f,t),s(f)},onError:f=>{fe(f,t),y(f)},onAbort:()=>{s(null)}})})}function ue(){const t=e.maxSize?e.maxSize*1024:1/0,a=typeof e.filter=="string"?e.filter?[e.filter]:[]:e.filter.filter(r=>r);for(let r=0,n=d.value.length;r<n;++r){const u=d.value[r],o=oe(u);if(a.length&&!a.includes(o))return g.emitEvent(e.onFilterError,u),!1;if(u.size>t)return g.emitEvent(e.onSizeError,u),!1}return!0}function B(t){t.status=c.StatusType.DELETE,t.xhr&&t.xhr.abort(),V(),g.emitEvent(e.onDelete,t),T()}function ce(t){g.emitEvent(e.onPreview,t)}function V(){if(!v.isClient)return;const t=new DataTransfer;d.value=d.value.filter(a=>a.status!==c.StatusType.DELETE),d.value.forEach(a=>{a.source&&t.items.add(a.source)}),x.value&&(x.value.files=t.files)}function de(t,a){a.status!==c.StatusType.DELETE&&(a.percentage=t,g.emitEvent(e.onProgress,a,t),T())}function pe(t,a){a.status!==c.StatusType.DELETE&&(a.status=c.StatusType.SUCCESS,a.response=t,a.error=null,g.emitEvent(e.onSuccess,a,t),T())}function fe(t,a){a.status!==c.StatusType.DELETE&&(a.status=c.StatusType.FAIL,a.error=t,g.emitEvent(e.onError,a,t),T())}let C;l.onBeforeUnmount(()=>{clearTimeout(C)});async function me(t){if(!!e.allowDrag&&(clearTimeout(C),t.preventDefault(),E.value=!1,t.dataTransfer)){const a=await he(t.dataTransfer);a.length&&U(a)}}function ge(t){!e.allowDrag||(clearTimeout(C),t.preventDefault(),E.value=!0)}function ve(t){!e.allowDrag||(t.preventDefault(),C=setTimeout(()=>{E.value=!1},100))}async function he(t){var f,L;const{items:a,files:r}=t;if(!a.length)return[];const n=[],u=[],o=[];for(let m=0,b=a.length;m<b;++m){const S=(L=(f=a[m]).webkitGetAsEntry)==null?void 0:L.call(f);if(!S)return r;S.isFile?n.push(r[m]):u.push({dir:S,prefix:""})}if(!e.directory||!u.length)return n;const p=[];let s=e.countLimit-(e.selectToAdd?d.value.length:0);s=Math.round(s)>0?s:100;const y=()=>{for(;u.length;){const m=u.shift(),b=m.dir,S=m.prefix?`${m.prefix}/${b.name}`:b.name,w=b.createReader();o.push(new Promise(Ee=>{w.readEntries(Te=>{Te.forEach(A=>{A.isFile?p.push({entry:A,prefix:S}):u.push({dir:A,prefix:S})}),Ee()})}))}};for(;y(),await Promise.all(o),!(!u.length||p.length>=s););return p.length>0?n.concat(await Promise.all(p.map(({entry:m,prefix:b})=>new Promise(S=>m.file(w=>{w.path=`${b}/${w.name}`,S(w)}))))):n}function be(){return!e.allowDrag&&!e.disabledClick?l.createVNode(l.Fragment,null,[l.createVNode(O,{ref:P,inherit:!0,size:X.value,icon:D.Upload,type:e.state,disabled:e.disabled,loading:e.loading,"loading-icon":e.loadingIcon,"loading-spin":e.loadingSpin},{default:()=>{var t;return[(t=e.buttonLabel)!=null?t:N.value.upload]}}),h.tip?h.tip():e.tip&&l.createVNode("p",{class:i.be("tip")},[e.tip])]):l.createVNode("div",{ref:j,class:[i.be("drag-panel"),e.disabled&&i.bem("drag-panel","disabled")],tabindex:0},[l.createVNode(F,{class:[i.be("cloud"),e.disabled&&i.bem("cloud","disabled")],scale:4},{default:()=>[l.createVNode(D.CloudArrowUp,null,null)]}),h.tip?h.tip():l.createVNode("p",{class:i.be("tip")},[e.tip||N.value.dragOrClick]),l.createVNode(F,{class:i.be("loading-icon"),spin:e.loadingSpin,pulse:!e.loadingSpin,icon:e.loadingIcon,style:{opacity:e.loading?"100%":"0%"}},null)])}function ye(){var t;return l.createVNode("div",{class:[i.be("image-action"),e.disabled&&i.bem("image-action","disabled")]},[h.default?h.default({isDragOver:(e.allowDrag||e.disabledClick)&&E.value}):l.createVNode(l.Fragment,null,[e.loading?l.createVNode(F,{class:i.be("loading-icon"),spin:e.loadingSpin,pulse:!e.loadingSpin,icon:e.loadingIcon,style:{marginBottom:"6px"}},null):l.createVNode(F,{class:[i.be("cloud"),e.disabled&&i.bem("cloud","disabled")],scale:1.2,style:{marginBottom:"6px"}},{default:()=>[l.createVNode(D.Plus,null,null)]}),l.createVNode("span",null,[(t=e.buttonLabel)!=null?t:N.value.upload])])])}function $(){const t=e.image?"li":"div";return l.createVNode(t,{class:te.value,tabindex:-1,onClick:z,onDrop:me,onDragover:ge,onDragleave:ve,onKeydown:le},{default:()=>[!e.disabledClick&&l.createVNode("input",{ref:x,type:"file",class:i.be("input"),disabled:e.disabled,multiple:e.multiple,accept:ae.value,webkitdirectory:e.directory,onChange:ie},null),e.image?ye():h.default?h.default({isDragOver:(e.allowDrag||e.disabledClick)&&E.value}):be()]})}function Se(){return l.createVNode(G,{inherit:!0,files:k.value,"select-to-add":e.selectToAdd,type:e.image?"thumbnail":e.listType,"icon-renderer":e.iconRenderer,"loading-text":e.loadingText,"can-preview":e.canPreview,style:e.listStyle,onDelete:B,onPreview:ce},{item:h.item,icon:h.icon,suffix:()=>e.image&&(!e.maxSize||k.value.length<e.maxSize)?$():null})}return()=>l.createVNode("div",{id:K.value,class:ee.value},[!e.image&&$(),!e.hiddenFiles&&Se()])},methods:{execute:v.noop,handleDelete:v.noop}});module.exports=Ne;
